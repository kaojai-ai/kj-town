name: Upgrade Town With Codex

on:
  workflow_dispatch:
  schedule:
    - cron: '30 4 * * 2'

permissions:
  contents: write

jobs:
  upgrade-town:
    runs-on: ubuntu-latest
    outputs:
      final_message: ${{ steps.run_codex.outputs.final-message }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Fetch latest changelog
        shell: bash
        run: |
          year="$(date +%Y)"
          month="$(date +%m)"
          today="$(date +%F)"
          epoch="$(date +%s)"

          url="https://blog.kaojai.ai/blog/${year}/${month}/changelog-${today}/llms.txt"
          target_dir="migrations/${year}"
          tmp_file="$(mktemp)"
          pattern="${target_dir}"/*_changelog-"${today}".md

          mkdir -p "${target_dir}"
          curl -fsSL "${url}" -o "${tmp_file}"

          shopt -s nullglob
          for existing_file in ${pattern}; do
            if cmp -s "${tmp_file}" "${existing_file}"; then
              echo "Changelog content unchanged. Reusing ${existing_file}"
              rm -f "${tmp_file}"
              exit 0
            fi
          done
          shopt -u nullglob

          target_file="${target_dir}/${epoch}_changelog-${today}.md"
          mv "${tmp_file}" "${target_file}"
          echo "Downloaded changelog to ${target_file}"

      - name: Run Codex migration upgrade
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: instructions/upgrade-town.md

      - name: Build project
        run: pnpm run build

      - name: Run tests (or fallback to typecheck)
        shell: bash
        run: |
          if pnpm run | grep -qE '^\s+test\b'; then
            pnpm test
          else
            pnpm run typecheck
          fi

      - name: Commit and push changes
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No changes detected after Codex run."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "chore: apply town upgrades via Codex"
          git push
